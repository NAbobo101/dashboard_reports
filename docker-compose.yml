# ------------------------------------------------------------------------------
# docker-compose.yml
# Serviços:
# - db_relatorios: MySQL 8 com volume persistente + init scripts
# - app: Streamlit (construído via Dockerfile)
# - adminer: UI simples para acessar o banco (opcional, útil em dev)
# - etl: Runner ETL (Mercado Livre)
# - meli_oauth: Serviço interno de OAuth (FastAPI) que faz init/consume/token + refresh
#
# Ajustes importantes:
# 1) Evita conflito de porta no host (MySQL publica em 3307:3306)
# 2) Evita colisão de DNS na rede shared internal_net (service name não é "db")
# 3) OAuth automático: WordPress só recebe code/state e repassa para meli_oauth via internal_net
#
# CORREÇÃO ADMINER:
# - O Adminer (e/ou o operador) estava tentando usar "db" como host.
# - O serviço real do MySQL chama "db_relatorios".
# - Adicionamos alias "db" na network backend para compatibilidade.
# - Definimos ADMINER_DEFAULT_SERVER para sugerir o host correto na UI.
# ------------------------------------------------------------------------------

services:
  db_relatorios:
    image: mysql:8.0
    container_name: project-mysql
    restart: unless-stopped

    env_file:
      - .env

    environment:
      MYSQL_INITDB_SKIP_TZINFO: "1"
      MYSQL_ROOT_HOST: "%"
      TZ: "America/Sao_Paulo"

    command: >
      --default-authentication-plugin=mysql_native_password
      --character-set-server=utf8mb4
      --collation-server=utf8mb4_0900_ai_ci

    ports:
      - "3307:3306"

    volumes:
      - mysql_data:/var/lib/mysql
      - ./db/init:/docker-entrypoint-initdb.d:ro

    # Mantemos internal_net e backend, mas agora com alias "db" no backend
    networks:
      backend:
        aliases:
          - db
      internal_net: {}

    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h 127.0.0.1 -p$${MYSQL_ROOT_PASSWORD} --silent"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 20s


  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: project-streamlit
    restart: unless-stopped

    env_file:
      - .env

    environment:
      # Pode usar db_relatorios (recomendado) ou "db" (alias de compatibilidade)
      DB_HOST: db_relatorios
      DB_PORT: "3306"
      DB_NAME: "core"

      STREAMLIT_RO_USER: "${STREAMLIT_RO_USER}"
      STREAMLIT_RO_PASSWORD: "${STREAMLIT_RO_PASSWORD}"

      DB_USER: "${STREAMLIT_RO_USER}"
      DB_PASSWORD: "${STREAMLIT_RO_PASSWORD}"

      STREAMLIT_SERVER_HEADLESS: "true"
      TZ: "America/Sao_Paulo"

    ports:
      - "8501:8501"

    depends_on:
      db_relatorios:
        condition: service_healthy

    networks:
      - backend

    volumes:
      - ./app:/app/app:rw


  adminer:
    image: adminer:4
    container_name: project-adminer
    restart: unless-stopped

    depends_on:
      db_relatorios:
        condition: service_healthy

    ports:
      - "8080:8080"

    environment:
      # Faz o campo "Server" já vir preenchido corretamente.
      ADMINER_DEFAULT_SERVER: db_relatorios

    networks:
      - backend


  # ----------------------------------------------------------------------------
  # Serviço interno OAuth (FastAPI)
  # ----------------------------------------------------------------------------
  meli_oauth:
    image: python:3.11-slim
    container_name: relatorios-meli-oauth
    restart: unless-stopped

    env_file:
      - .env

    environment:
      # DB (schema mercado_livre)
      MYSQL_HOST: db_relatorios
      MYSQL_PORT: "3306"
      MYSQL_DATABASE: "mercado_livre"
      MYSQL_USER: "${ETL_USER}"
      MYSQL_PASSWORD: "${ETL_PASSWORD}"

      # Mercado Livre OAuth (segredos ficam aqui, não no WordPress)
      MELI_CLIENT_ID: "${MELI_CLIENT_ID}"
      MELI_CLIENT_SECRET: "${MELI_CLIENT_SECRET}"
      MELI_REDIRECT_URI: "${MELI_REDIRECT_URI}"
      MELI_SCOPE: "${MELI_SCOPE:-offline_access read write}"

      # Proteção dos endpoints internos
      MELI_INTERNAL_KEY: "${MELI_INTERNAL_KEY}"

      TZ: "America/Sao_Paulo"
      PYTHONPATH: "/app"  # Garante que "etl" seja encontrado como package

    depends_on:
      db_relatorios:
        condition: service_healthy

    networks:
      - backend
      - internal_net

    volumes:
      - ./etl:/app/etl:rw
      - ./etl/requirements.txt:/app/requirements.txt:ro

    working_dir: /app

    command: >
      bash -lc "
        pip install --no-cache-dir -r /app/requirements.txt &&
        uvicorn etl.mercado_livre.oauth.service:app --host 0.0.0.0 --port 8000
      "


  # ----------------------------------------------------------------------------
  # Runner ETL Mercado Livre
  # ----------------------------------------------------------------------------
  etl:
    image: python:3.11-slim
    container_name: project-etl
    restart: unless-stopped

    env_file:
      - .env

    environment:
      # MySQL (schema mercado_livre)
      MYSQL_HOST: db_relatorios
      MYSQL_PORT: "3306"
      MYSQL_DATABASE: "mercado_livre"
      MYSQL_USER: "${ETL_USER}"
      MYSQL_PASSWORD: "${ETL_PASSWORD}"

      # Serviço interno OAuth (tokens/refresh)
      MELI_OAUTH_SERVICE_URL: "http://relatorios-meli-oauth:8000"
      MELI_INTERNAL_KEY: "${MELI_INTERNAL_KEY}"
      MELI_SELLER_ID: "${MELI_SELLER_ID}"

      TZ: "America/Sao_Paulo"
      PYTHONPATH: "/app"

    depends_on:
      db_relatorios:
        condition: service_healthy
      meli_oauth:
        condition: service_started

    networks:
      - backend
      - internal_net

    volumes:
      - ./etl:/app/etl:rw
      - ./etl/requirements.txt:/app/requirements.txt:ro

    working_dir: /app

    command: >
      bash -lc "
        pip install --no-cache-dir -r /app/requirements.txt &&
        tail -f /dev/null
      "


networks:
  backend:
    name: project-backend
    driver: bridge

  internal_net:
    external: true
    name: internal_net


volumes:
  mysql_data:
    name: project-mysql-data
