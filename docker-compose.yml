version: "3.9"

# ------------------------------------------------------------------------------
# docker-compose.yml
# Serviços:
# - db: MySQL 8 com volume persistente + init scripts
# - app: Streamlit (construído via Dockerfile)
# - adminer: UI simples para acessar o banco (opcional, útil em dev)
#
# Correções principais:
# 1) App passa a conectar usando o usuário read-only (STREAMLIT_RO_USER/PASSWORD)
# 2) DB_NAME passa a ser "core" (garante que o usuário tenha permissão no DB da URL)
# 3) Healthcheck do MySQL usa CMD-SHELL e a variável do próprio container (mais confiável)
# 4) Opcional: MYSQL_ROOT_HOST='%' para permitir root remoto em DEV (Adminer/debug)
# ------------------------------------------------------------------------------

services:
  db:
    image: mysql:8.0
    container_name: project-mysql
    restart: unless-stopped

    # Carrega variáveis do arquivo .env (não commitar)
    env_file:
      - .env

    environment:
      # Evita carregar timezones no init (reduz tempo de bootstrap)
      MYSQL_INITDB_SKIP_TZINFO: "1"

      # Permite login de root pela rede docker (DEV).
      # Em produção, recomenda-se restringir.
      MYSQL_ROOT_HOST: "%"

      # Opcional: define timezone dentro do container
      TZ: "America/Sao_Paulo"

    # Ajustes de servidor:
    # - mysql_native_password: compatibilidade com alguns clientes
    # - character-set / collation: padronização
    command: >
      --default-authentication-plugin=mysql_native_password
      --character-set-server=utf8mb4
      --collation-server=utf8mb4_0900_ai_ci

    ports:
      # Expor no host para ferramentas locais (DBeaver etc.)
      - "3306:3306"

    volumes:
      # Dados persistentes
      - mysql_data:/var/lib/mysql

      # Scripts .sql/.sh aqui rodam na primeira inicialização do volume
      # Atenção: se o volume já existe, scripts não rodam novamente.
      - ./db/init:/docker-entrypoint-initdb.d:ro

    networks:
      - backend

    # Healthcheck robusto:
    # - CMD-SHELL executa via shell dentro do container
    # - $$ escapa para o Compose não tentar substituir; quem substitui é o shell no container
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h 127.0.0.1 -p$${MYSQL_ROOT_PASSWORD} --silent"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 20s


  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: project-streamlit
    restart: unless-stopped

    env_file:
      - .env

    environment:
      # Conexão com MySQL via rede docker
      DB_HOST: db
      DB_PORT: "3306"

      # IMPORTANTE:
      # DB_NAME precisa ser um database que o usuário tenha permissão,
      # pois ele entra na URL de conexão. Como seu read-only tem SELECT em core.*,
      # apontar pra "core" evita "Access denied to database".
      DB_NAME: "core"

      # Correção principal:
      # O Streamlit deve usar o usuário read-only criado no init (least privilege).
      # Essas vars devem existir no .env:
      # STREAMLIT_RO_USER=streamlit_ro
      # STREAMLIT_RO_PASSWORD=...
      STREAMLIT_RO_USER: "${STREAMLIT_RO_USER}"
      STREAMLIT_RO_PASSWORD: "${STREAMLIT_RO_PASSWORD}"

      # Mantemos DB_USER/DB_PASSWORD também, para compatibilidade com o seu main.py
      # (ele pode ler DB_USER/DB_PASSWORD ou STREAMLIT_RO_* dependendo da versão).
      DB_USER: "${STREAMLIT_RO_USER}"
      DB_PASSWORD: "${STREAMLIT_RO_PASSWORD}"

      # Streamlit em container (sem tentar abrir browser)
      STREAMLIT_SERVER_HEADLESS: "true"

      # Opcional: timezone do container
      TZ: "America/Sao_Paulo"

    ports:
      - "8501:8501"

    depends_on:
      db:
        condition: service_healthy

    networks:
      - backend

    # DEV: hot reload
    volumes:
      - ./app:/app/app:rw


  adminer:
    image: adminer:4
    container_name: project-adminer
    restart: unless-stopped
    depends_on:
      db:
        condition: service_healthy
    ports:
      - "8080:8080"
    networks:
      - backend



networks:
  backend:
    name: project-backend
    driver: bridge


volumes:
  mysql_data:
    name: project-mysql-data
